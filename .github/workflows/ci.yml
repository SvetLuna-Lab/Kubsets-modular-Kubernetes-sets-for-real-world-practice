name: ci

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  kind-smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          config: kind/cluster.yaml
          cluster_name: kubsets

      - name: Build web image (tag must match k8s manifest)
        run: |
          docker build -t kubsets-web:local ./app

      - name: Load image into kind
        run: |
          kind load docker-image kubsets-web:local --name kubsets

      - name: Deploy manifests
        run: |
          kubectl apply -f k8s/

      - name: Wait for DB
        run: |
          kubectl -n kubsets rollout status statefulset/db --timeout=180s

      - name: Wait for Web (non-fatal, diagnostics will follow)
        continue-on-error: true
        run: |
          kubectl -n kubsets rollout status deployment/web --timeout=180s

      - name: Diagnostics (always)
        if: always()
        run: |
          echo "=== kubsets: all ==="
          kubectl -n kubsets get all
          echo "=== kubsets: pods wide ==="
          kubectl -n kubsets get pods -o wide
          echo "=== kubsets: describe web pods ==="
          kubectl -n kubsets describe pod -l app=web || true
          echo "=== kubsets: web logs ==="
          kubectl -n kubsets logs -l app=web --tail=200 || true
          echo "=== kubsets: events (tail) ==="
          kubectl -n kubsets get events --sort-by=.lastTimestamp | tail -n 120

      - name: Fail if web is not Available
        run: |
          kubectl -n kubsets get deploy web -o jsonpath='{.status.availableReplicas}' | grep -E '^[1-9]' >/dev/null
