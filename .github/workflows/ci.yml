name: ci

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  kind-smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Install kind
        uses: helm/kind-action@v1.10.0
        with:
          config: kind/cluster.yaml
          cluster_name: kubsets

      - name: Build web image
        run: |
          docker build -t kubsets-web:ci ./app

      - name: Load image into kind
        run: |
          kind load docker-image kubsets-web:ci --name kubsets

      - name: Deploy manifests
        run: |
          kubectl apply -f k8s/

      - name: Wait for DB ready
        run: |
          kubectl -n kubsets rollout status statefulset/db --timeout=180s

      - name: Wait for Web ready
        run: |
          kubectl -n kubsets rollout status deployment/web --timeout=180s

      - name: Wait for migrate Job complete (if created)
        run: |
          # Job is created by manifests; wait only if it exists
          if kubectl -n kubsets get job migrate >/dev/null 2>&1; then
            kubectl -n kubsets wait --for=condition=complete job/migrate --timeout=180s
          else
            echo "Job/migrate not found â€” skipping"
          fi

      - name: Show status
        if: always()
        run: |
          kubectl -n kubsets get all
          echo "---- pods ----"
          kubectl -n kubsets get pods -o wide
          echo "---- events ----"
          kubectl -n kubsets get events --sort-by=.lastTimestamp | tail -n 60

      - name: Show logs (web + db)
        if: always()
        run: |
          echo "---- web logs ----"
          kubectl -n kubsets logs deploy/web --tail=200 || true
          echo "---- db logs ----"
          kubectl -n kubsets logs statefulset/db --tail=200 || true
